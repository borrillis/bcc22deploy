---
layout: post
title: Using Web Services from an XNA 4.0 WP7 Game
tags: ['VS2010', '.Net 4.0']
date: 6/17/2010 5:57:53 PM
draft: false
---

<p>Now that the Windows Phone 7 development tools have been out for a while, let’s talk about how you can use them. Windows Phone 7 ( WP7 ) has two application types that you can create, either Silverlight or XNA, and you can’t really mix the two together. The development environment for WP7 is a special edition of Visual Studio 2010 called Visual Studio 2010 Express for Windows Phone. This edition will be installed with the WP7 tools, even if you have a full edition of VS2010 already installed. While you can use your full edition of VS2010 to do WP7 development, this astute developer has noticed that there are a few things that you can only do in the Express for Windows Phone edition.</p>  <p>So lets start by discussing WP7 networking. On the WP7 platform the only networking available is through Web Services using WCF or if you’re really masochistic, you’ll use the WebClient to do http. In Silverlight, it’s fairly easy to wire up a WCF proxy to call a web service and get some data. In the XNA projects, not so much.</p>  <h5>Create WCF Service</h5>  <p>First, we’ll create our service that will return some information that we need in our game. Open Visual Studio 2010, and create a new WCF Web Service project.</p>  <p><a href="http://gwb.blob.core.windows.net/mathoms/WindowsLiveWriter/UsingWebServicesfromanXNA4.0WP7Game_781B/image_4.png" rel="lightbox"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="/Media/Default/Media/Default/Migrated/image_thumb_1.png" width="244" height="170"></a> </p>  <p>We’ll use the default implementation as we only need to see how to use a service, we are not interested in creating a really cool service at this point. However you may want to follow the instructions in the comments of Service1.svc.cs to change the name to something better, I used DataService and IDataService for the interface. You should now be able to run the project and the WCF Test Client will load and properly enumerate your service.</p>  <p><a href="http://gwb.blob.core.windows.net/mathoms/WindowsLiveWriter/UsingWebServicesfromanXNA4.0WP7Game_781B/image_6.png" rel="lightbox"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="/Media/Default/Media/Default/Migrated/image_thumb_2.png" width="244" height="144"></a></p>  <p>At this point we have a functional service that can be consumed by our XNA game.</p>  <h5>Consume the WCF Service</h5>  <p>Open Visual Studio 2010 Express for Windows Phone and create a new XNA Game Studio 4.0 Windows Phone Game project.</p>  <p><a href="http://gwb.blob.core.windows.net/mathoms/WindowsLiveWriter/UsingWebServicesfromanXNA4.0WP7Game_781B/image_10.png" rel="lightbox"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="/Media/Default/Media/Default/Migrated/image_thumb_3.png" width="244" height="167"></a> </p>  <p>Now if you try to add a service reference to the project, you’ll notice that the option is not available.</p>  <p><a href="http://gwb.blob.core.windows.net/mathoms/WindowsLiveWriter/UsingWebServicesfromanXNA4.0WP7Game_781B/image_12.png" rel="lightbox"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="/Media/Default/Media/Default/Migrated/image_thumb_4.png" width="244" height="224"></a> </p>  <p>However, if you add a Silverlight application to your solution, you’ll notice that you can create a service reference there.</p>  <p><a href="http://gwb.blob.core.windows.net/mathoms/WindowsLiveWriter/UsingWebServicesfromanXNA4.0WP7Game_781B/image_14.png" rel="lightbox"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="/Media/Default/Media/Default/Migrated/image_thumb_5.png" width="203" height="244"></a> </p>  <p>  <p>  <p>  <p>So using the Silverlight project, we can create the service reference.</p>  <p><a href="http://gwb.blob.core.windows.net/mathoms/WindowsLiveWriter/UsingWebServicesfromanXNA4.0WP7Game_781B/image_16.png" rel="lightbox"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="/Media/Default/Media/Default/Migrated/image_thumb_6.png" width="244" height="228"></a> </p>  <p>Unfortunately you can’t reference the Silverlight project from the XNA Game project, so using Windows Explorer copy the Service References folder from the Silverlight project directory to the XNA Game project directory, then add the folder to your XNA Game project. You’ll need to set the property Build Action to None for all the files, except for Reference.cs, which should be Build. Truely, we only need Reference.cs but I find it easier to copy the whole folder. If you try to compile at this point, you’ll notice that we are missing  a couple of references, System.Runtime.Serialization, System.Net and System.ServiceModel. Add these to the XNA Game project and you should build successfully. You’ll also need to copy the ServiceReference.ClientConfig file and add it to your project. The WCF infrastructure looks for this file and will complain if it can’t find it. You’ll need to set the Copy to Output Directory property to Copy if Newer.</p>  <p>We now need to add the code to call the service and display the results on the screen. Go ahead and add a SpriteFont resource to the Content project and load it in the Game project. There’s nothing here that’s changed much from 3.1 other than your Content project is now under the Solution node and not the Project node. While you’re at it, add a string field to store the result of the service call, and intialize it to string.Empty. Then in the Draw method, write the string out to the screen, only if it does not equal string.Empty.</p>  <p>Now to wrap this up, lets create a new field that’s of the type DataServiceClient. In the Initialize Method, create a new instance of this type using its default contructor, then in the LoadContent we can call the service. Since we can only call the GetData method of our service asynchronously we need to set up a Completed event handler first. Thankfully, Visual Studio helps out a lot there just create, using the tab key whatever VS says to. In the GetDataAsyncCompleted event handler assign the service result ( e.Result) to your string field.</p>  <p>If you run your game, you should get something like this :</p>  <p><a href="http://gwb.blob.core.windows.net/mathoms/WindowsLiveWriter/UsingWebServicesfromanXNA4.0WP7Game_781B/image_20.png" rel="lightbox"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="/Media/Default/Media/Default/Migrated/image_thumb_8.png" width="125" height="244"></a> </p>  <p>Enjoy!</p>  <p>Edit: The project files are on <a href="http://cid-75af48400819b619.office.live.com/self.aspx/Public/Blog%20Projects/MyWCFEnabledGame.zip" target="_blank">my SkyDrive</a></p>

